
<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>Youtube: Get all vids of a youtube user, channel or playlist</title>
	<script src="lib/jquery.min.v1.10.2.js"></script>
	<script src="lib/papaparse.min.js"></script> <!-- from https://papaparse.com -->
	<link rel="stylesheet" href="./style.css">
</head>
<body>

<div class="starter">
	<div class="title">
		<h1>YouTube Metrics2go</h1>
	</div>
	<div class="inputs">
		<div class="inputbox">
			<p>API<img src="./asset/question-mark.png"></p><input id="accesskey" type="text" size="50" value="AIzaSyAGCQow6C8n2NHtzCrTgyhO2nNJBIm0Xwc">
		</div>
		<div class="inputbox">
			<p>Ziel<img src="./asset/question-mark.png"></p><input id="playlistId" type="text" size="40" value="UUT7EcU7rC44DiS3RkfZzZMg">
		</div>
	</div>
	<div class="inputs">
		<div class="inputbox">
			<p>Anzahl Videos<img src="./asset/question-mark.png"></p><input id="vidslimit" type="text" value="200" size="5">
		</div>
		<div class="inputbox">
			<p>Startpaginierung<img src="./asset/question-mark.png"></p><input id="startToken" type="text" value="" size="40"><p></p>
		</div>
	</div>
	<div class="go">
		<input id="search-btn" type="button" value="Datenabfrage starten">
	</div>
</div>

<div class="section-odd">
	<div class="progress">
		<h2>Ergebnis der Datenabfrage</h2>
		<p><textarea id="output" rows="16" cols="100"></textarea>
			<div class="inputbox uncool">
				<button onclick='download_file("vidsListing.csv", "output")'>Herunterladen</button></p>
				</div>
				<div class="inputbox">
				<button id="fullvids-btn">Erweiterte Daten abrufen</button></p>
			</div>
	</div>
</div>

<div class="progressbar">
	<div class="progress">
	</div>
</div>

<div class="errorMsg">
	<p>
		Fehler bei der Abfrage. Eingaben überprüfen und erneut versuchen.
	</p>
</div>
<input type="textStatus" id="status" size="50" disabled>
<div class="section-even">
	<div class="progress">
		<h2>Vollständige Daten</h2>
			<div class="inputbox">
				<div class="optionbox">
					<h3>Reduzierte Version</h3>
					<p>Beinhaltet alle Basisinformationen wie Datum, Länge, Klicks, Likes und Kommentaranzahl.</p>
					<div class="selection">
						<button onclick='download_file("vidsData.json", "json")'>JSON-Format</button>
						<button onclick='download_file("vidsData.csv", "csv")'>CSV-Format</button>
					</div>
				</div>
				<div class="optionbox">
					<h3>Vollständiger Dump</h3>
					<p>Beinhaltet alle verfügbaren Daten, wie Beschreibung, Tags, Metadaten und mehr.</p>
					<div class="selection">
						<button onclick='download_file("fulljson.json", "fulljson")'>JSON-Format</button>
						<button onclick='download_file("fullcsv.csv", "fullcsv")'>CSV-Format</button>
					</div>
				</div>
			</div>
	</div>
</div>
<textarea id="tokensList" rows="10" cols="30"></textarea></p>

<script>
var vidsList = [];
var accumulator = [];
var tokensList = [];
var accumulatorFull = [];


// When the Basic Listing button is pressed
$("#search-btn").on("click", function() {
	//set div transparency to 0
	$(".starter").css("opacity", "0");
	//after delay of 2 seconds, hide the div
	setTimeout(function() {
		$(".starter").hide();
		$(".section-odd").css("display", "unset");
		$(".section-odd").css("opacity", "1");
	}, 700);

	// to trigger on a button click
	document.getElementById("output").value = '"num","date","title","id","link"\n';
	var params = {
		"vidslimit" : parseInt( document.getElementById("vidslimit").value ) || 50,
		"accessKey" : 'AIzaSyAGCQow6C8n2NHtzCrTgyhO2nNJBIm0Xwc', 
		"playlistId" : document.getElementById("playlistId").value
	}
	//document.getElementById("output").value = JSON.stringify(params, null, 2);
	vidsList = []; //reset
	tokensList = "vids done,nextPageToken for playlistId: "+params.playlistId + "\n";
	var pageToken = document.getElementById("startToken").value || '';
	getVideos(pageToken,0,params);
});

// When the Detailed data fetching button is pressed
$("#fullvids-btn").on("click", function() {
		// hide div class section-odd
		$(".section-odd").css("opacity", "0");
		$(".progressbar").css("opacity", "1");
		setTimeout(function() {
			accumulator = [], accumulatorFull = []; // reset
			document.getElementById("status").value = "Fetching... "
			fetchViddetails( 0 );
			$(".section-odd").css("display", "none");
		}, 700);

		//check after 5 seconds if the accumulator is still empty, if so, show error message
		setTimeout(function() {
			if (accumulator.length == 0) {
				$(".errorMsg").css("display", "unset");
				$(".errorMsg").css("opacity", "1");
				$(".progressbar").css("opacity", "0");
			}
		}, 2000);
});

// Recursive function for cycling through the playlist, 50 videos at a time. Upon successful API call, the function gets the next list's token and calls itself again. It stops calling itself when the total videos count has been reached (to exact or immediate next multiple of 50)
function getVideos(nextPageToken, vidsDone, params) {
	$.getJSON("https://www.googleapis.com/youtube/v3/playlistItems", {
		key: params.accessKey ,
		part: "snippet",
		maxResults: 50,
		playlistId: params.playlistId,
		//fields: "items(snippet(publishedAt,resourceId/videoId,title)),nextPageToken,pageInfo/totalResults",
		fields: "items(snippet(publishedAt,resourceId/videoId,title)),nextPageToken",
		pageToken: ( nextPageToken || '' )
		}, 
		function(data) {
			// process JSON variable, extract the 50 videos info		
			for (i=0; i < data.items.length; i++) {
				vidsDone ++;
				document.getElementById("output").value += vidsDone + ',"' + data.items[i].snippet.publishedAt.substr(0,10) + '","' + data.items[i].snippet.title + '","' + data.items[i].snippet.resourceId.videoId + '","' + 'https://youtu.be/' + data.items[i].snippet.resourceId.videoId  + '"\n';
				// 
				vidsList.push(data.items[i].snippet.resourceId.videoId);
			}
			
			// Archiving tokens:
			tokensList += vidsDone + ',' + data.nextPageToken + '\n'; 	

			// from https://stackoverflow.com/a/26557626/4355695
			document.getElementById("output").scrollTop = document.getElementById("output").scrollHeight;
			
			if ( vidsDone < params.vidslimit) {
				getVideos( data.nextPageToken, vidsDone , params);
			} 
			 else { // closing actions to do once we have listed the videos needed.
			 	document.getElementById("tokensList").value = tokensList;
			 }
		}
	).fail(function(jqXHR, textStatus, errorThrown) {
			document.getElementById("output").value += 'Error : ' + ( jqXHR.responseText || errorThrown ) + '\n\n';
		}
	);
}

// Find total number of videos 
function findTotalVids( ) {
	$.getJSON("https://www.googleapis.com/youtube/v3/playlistItems", {
	key: document.getElementById("accesskey").value,
	playlistId: document.getElementById("playlistId").value,
	part: "snippet",
	fields: "pageInfo/totalResults"
	},
	function(data) {
		document.getElementById("vidslimit").value = data.pageInfo.totalResults;
	});
}

// Recursive function that fetches the details of each video in the playlist
function fetchViddetails( i ) {
	$.getJSON("https://www.googleapis.com/youtube/v3/videos", {
		key: document.getElementById("accesskey").value,
		part: "snippet,statistics,contentDetails,topicDetails",
		id: vidsList[i]
		}, function(data) {
			
			accumulatorFull.push(data); // storing the full JSON response received from Youtube

			var description = encodeURI(data.items[0].snippet.description);
			var vidInfo = {
				"num" : (accumulator.length + 1),
				"id" : vidsList[i],
				"title" : data.items[0].snippet.title,
				"date" : data.items[0].snippet.publishedAt.substr(0,10),
				"viewcount" : data.items[0].statistics.viewCount,
				"likes" : data.items[0].statistics.likeCount,
				"dislikes" : data.items[0].statistics.dislikeCount,
				"thumbnail" : data.items[0].snippet.thumbnails.high.url,
				"link" : 'https://youtu.be/' + vidsList[i],
				"tags" : data.items[0].snippet.tags ? data.items[0].snippet.tags.join() : "",
				"description" : description
			}
			accumulator.push(vidInfo);

			// increase width of div progress by 1% for each video processed from 0 to 100%, then set opacity to 0
			$(".progress").css("width", (accumulator.length / vidsList.length * 100) + "%");
			if (accumulator.length == vidsList.length) {
				$(".progressbar").css("opacity", "0");
				$(".section-even").css("display", "unset");
				$(".section-even").css("opacity", "1");
			}

			document.getElementById("status").value = "Fetched details of " + accumulator.length + " videos total";
			if( i < vidsList.length - 1) {
				fetchViddetails( i+1 ) //recursive : calls itself if the list isn't over.
			}
	}).fail(function(jqXHR, textStatus, errorThrown) {
		document.getElementById("status").value = 'Error : ' + ( jqXHR.responseText || errorThrown ) + '\n\n';
	}
	);
}

// download link: Adapted from https://stackoverflow.com/a/35251739/4355695
function dynamic_text(id) {
	if(id == 'json')
    	return JSON.stringify(accumulator, null, 2);
    else if (id == 'csv') 
    	return contentString = Papa.unparse(accumulator, {quotes: true});
    else if (id == 'fulljson')
    	return JSON.stringify(accumulatorFull, null, 2);
	else if (id == 'fullcsv')
		return contentString = Papa.unparse(accumulatorFull, {quotes: true});
    else
        return document.getElementById(id).value;
    }

function download_file(name, id, mime_type) {
	// Adapted from https://stackoverflow.com/a/35251739/4355695
    mime_type = mime_type || "text/plain";

    var contentString = dynamic_text(id);

    if( !contentString.length || contentString=='[]' ) { alert('No Data! Check the previous step.'); return; }

	var blob = new Blob([contentString], {type: mime_type});
	var dlink = document.createElement('a');
	dlink.download = name;
	dlink.href = window.URL.createObjectURL(blob);
	dlink.onclick = function(e) {
	// revokeObjectURL needs a delay to work properly
	var that = this;
	setTimeout(function() {
		window.URL.revokeObjectURL(that.href);
	}, 1500);
	};

	dlink.click();
	dlink.remove();
}

;

</script>

<!-- <footer>JavaScript Fundamentals by <a href="mailto:nikhil.js@gmail.com">Nikhil VJ</a>.
</footer> -->


</body>
</html>
